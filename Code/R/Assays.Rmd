

```{r}
library(tidyverse)
library(gridExtra)
file_path= "../../Data/Compiled/SVG_LDH_ALL.csv"
df <- read.csv(file_path)
# replace blanks with 0 ug/ml and split the treatment into numbers and units
df <- 
  df %>% 
  mutate(treatment = str_replace(treatment, "Blank", "0 ug/ml"),
         treatment = str_replace(treatment, "20 ug/ml \\+ 50 ppm", "70 ug/ml"),
         treatment = str_replace(treatment, "50 ug/ml \\+ 100 ppm", "150 ug/ml"),
         treatment = str_replace(treatment, "100 ug/ml \\+ 200 ppm", "300 ug/ml")) %>% 
  separate(treatment, into=c("treatment", "units"), sep=" ") %>% 
  mutate(treatment = as.numeric(treatment)) %>% 
  unite(group, condition, exposure_time, sep="_")


# Scale all the values to the blank(treatment = 0) in every condition at every exposure time for every compound
scaling_lst <- 
  df %>% 
  unite(group, compound, group, sep=",") %>% 
  split(.$group)


df_scaled <- 
  lapply(names(scaling_lst), function(x){
    scale_mean <- 
      scaling_lst[[x]] %>% 
      filter(group == x, treatment == 0) %>% 
      select(response) %>% 
      pull %>% 
      mean
    
    scaling_lst[[x]] %>% 
      mutate(response = ((response -scale_mean)/sd(response)))
  }) %>% 
  bind_rows() %>% 
  separate(group, into=c("compound", "group"), sep=",")

plot_and_save <- function(cmpnd, assay){
  title <- paste(cmpnd, " - ", assay, " for Human Astroglial Cells (SVGp12)", sep="")
  file_path <- paste("../../Graphs/SVG/SVG_", cmpnd, "_", assay, "N_NS.png", sep="")
  df_scaled %>%
  filter(compound==cmpnd) %>%
  mutate(group = factor(group, levels = c("Normoxia_24 Hours", "Hypoxia_24 Hours",
                                            "Normoxia_48 Hours", "Hypoxia_48 Hours"))) %>% 
  arrange(group) %>% 
  ggplot(mapping=aes(x=treatment, y=response, color=group)) +
  geom_jitter(width=0.3, alpha= 0.5) +
  stat_smooth(method="lm", se=FALSE) +
  labs(title= title,
       x="Treatment (Î¼g/ml)", y="LDH (Cell Leakage)", 
       color="Condition_Exposure Time") +
    theme_bw(base_size= 5)
  
#ggsave(file_path, device = "png", width=10, type="cairo")
}


p1<- plot_and_save("DEP", "LDH")
p2<- plot_and_save("Ox66", "LDH")
p3<- plot_and_save("DEP + Ox66", "LDH")

g <- arrangeGrob(p1,p2,p3, nrow = 3)

ggsave("../../Graphs/compiled_trends.png", g, device="png")

```


```{r}
#Function for finding the slope coefficient 
find_mdl_coefficient <- function(x,y){
  coef(summary(lm(y~x)))[2,1]
}

#Function for finding the slope coefficient confidence interval
find_mdl_coefficient_ce <- function(x,y){
  lin_mod <- lm(y~x)
  std_err <- coef(summary(lin_mod))[2,2]
  df <- length(residuals(lin_mod))
  crit_t <- abs(qt(0.05/2, df))
  (crit_t * std_err)
}

plot_ces <- function(cmpnd, assay){
  df_slopes <- 
    df_scaled %>% 
    group_by(compound, group) %>% 
    summarise(slope = find_mdl_coefficient(treatment, response),
              slope_err = find_mdl_coefficient_ce(treatment,response)) %>% 
    mutate(slope_min = slope-slope_err, slope_max=slope+slope_err) 
    
  df_slopes_dep <-
    df_slopes %>% 
    filter(compound== cmpnd) %>% 
    mutate(group = factor(group, levels = c("Normoxia_24 Hours", "Hypoxia_24 Hours",
                                              "Normoxia_48 Hours", "Hypoxia_48 Hours"))) %>% 
    arrange(group)
  
  title <- sprintf("Slope Confidence Intervals for SVGp12 dosed with %s (%s)", cmpnd, assay)
  file_name <- sprintf("../../Graphs/SVG/SVG_%s_%s_CE.png", cmpnd, assay)
  x_lines <- c(rbind(df_slopes_dep$slope_min, df_slopes_dep$slope_max))
  y_lines <- rep(seq(from = nrow(df_slopes_dep), to = 1, by=-1)/2, each=2)
  x_dots <- rep(df_slopes_dep$slope, each=2)
  group <- rep(df_slopes_dep$group, each = 2)
  df_lines <- 
    data.frame(x=x_lines, y=y_lines, group=group) 
    
  ggplot(data=df_lines, mapping=aes(x=x_lines, y=y_lines, color=group)) + 
    geom_line() + 
    geom_point(x=x_dots, color="black") +
    labs(x="Regression Slopes 95% Confidence Intervals", y="", color="Condition_Exposure Time",
         title=title) +
    theme_bw() +
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
          panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
  
  ggsave(file_name, device = "png", height=3)
    
}

plot_ces("DEP", "LDH")
plot_ces("Ox66", "LDH")
plot_ces("DEP + Ox66", "LDH")



lnr_mdl.ox66.48 <- 
  df_scaled %>%
  filter(compound=="DEP + Ox66", group=="Normoxia_48 Hours" | group=="Hypoxia_48 Hours") %>% 
  lm(data=., response~treatment*group)

summary(lnr_mdl.ox66.48)
```

```{r}
find_mdl_coefficient_ce <- function(x,y){
  lin_mod <- lm(y~x)
  std_err <- coef(summary(lin_mod))[2,2]
  df <- length(residuals(lin_mod))
  crit_t <- abs(qt(0.05/2, df))
  c(std_err, crit_t * std_err)
}

ox66.normoxia.24_df <-
  df_scaled %>% 
  filter(compound == "Ox66", group=="Normoxia_24 Hours") 

ox66.normoxia.24 <- find_mdl_coefficient(ox66.normoxia.24_df$treatment, ox66.normoxia.24_df$response)
ox66.normoxia.24.ce <- find_mdl_coefficient_ce (ox66.normoxia.24_df$treatment, ox66.normoxia.24_df$response)

dep.normoxia.24_df <-
  df_scaled %>% 
  filter(compound == "DEP", group=="Normoxia_24 Hours") 

dep.normoxia.24 <- find_mdl_coefficient(dep.normoxia.24_df$treatment, ox66.normoxia.24_df$response)
ox66.normoxia.24.ce <- find_mdl_coefficient_ce (dep.normoxia.24_df$treatment, ox66.normoxia.24_df$response)

compare_coefs <- function(condition, exposure_time){
  grp<- paste(condition, "_", exposure_time, sep="")
  title <- sprintf("Comparison of Additive Slopes for %s at %s", exposure_time, condition)
  file_path <- sprintf("../../Graphs/SVG/compare_%s_%s.png", exposure_time,condition)
  ox66_df <- df_scaled %>% 
  filter(compound == "Ox66", group==grp) 
  coef.ox66 <-  find_mdl_coefficient(ox66_df$treatment, ox66_df$response)
  se.ox66 <- find_mdl_coefficient_ce(ox66_df$treatment, ox66_df$response)[1]

  
  dep_df <- 
    df_scaled %>% 
    filter(compound == "DEP", group==grp) 
  
  coef.dep <-  find_mdl_coefficient(dep_df$treatment, dep_df$response)
  se.dep <- find_mdl_coefficient_ce(dep_df$treatment, dep_df$response)[1]
  
  response.ox66 <- 
    df_scaled %>% 
    filter(compound == "Ox66", group==grp) %>% 
    group_by(treatment) %>% 
    summarise(response = mean(response)) %>% 
    select(response) %>% 
    pull
  
  response.dep <-
    df_scaled %>%
    filter(compound == "DEP", group==grp) %>% 
    group_by(treatment) %>% 
    summarise(response = mean(response)) %>% 
    select(response) %>% 
    pull


  
  dep_ox66_df <- df_scaled %>% 
  filter(compound == "DEP + Ox66", group==grp) 
  coef.dep.ox66 <-  find_mdl_coefficient(dep_ox66_df$treatment, dep_ox66_df$response)
  se.dep.ox66 <- find_mdl_coefficient_ce(dep_ox66_df$treatment, dep_ox66_df$response)[1]

  corrfact <- cor(response.dep, response.ox66)
  print(corrfact)
  se.combined <- sqrt((se.dep)^2 + (se.ox66)^2 + 2*corrfact)
  coef.combined <- coef.ox66 + coef.dep
  
  x_lines <-
    c(coef.combined - 1.96*se.combined, coef.combined + 1.96*se.combined,
      coef.dep.ox66 - 1.96*se.dep.ox66, coef.dep.ox66 + 1.96*se.dep.ox66)
  y_lines <- c(1.5,1.5,1,1)
  groups <- c("Combined Calculated", "Combined Calculated", "Combined Experimental", "Combined Experimental")
  
  df_lines2 <- data.frame(x=x_lines, y=y_lines, group = groups) %>% 
  
  print(c(coef.combined + 1.96*se.combined, coef.combined + 1.96*se.combined))
  ggplot(data=,df_lines2, mapping= aes(x=x, y=y, color=group)) +
    geom_line(aes(group=group)) +
    theme_bw(base_size = 5) +
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
          panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    geom_point(aes(x=c(coef.combined, coef.combined, coef.dep.ox66, coef.dep.ox66), y=c(1.5,1.5,1,1), color=group)) +
    ylim(1,1.5) +
    labs(title = title, x="Regression Slopes 95% Confidence Intervals", y="", color="Group") 
    
 
  ggsave(file_path, device = 'png', height=2, width=5)
}

compare_coefs("Hypoxia", "48 Hours")
```

```{r}

```


